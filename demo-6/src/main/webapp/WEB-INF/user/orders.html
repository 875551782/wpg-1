<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<style>
	.order_num{
		width: 80px;
		height: 34px;
		text-align:center;
		border-radius:5%;
	}
	.order_info{
		width:450px;
		overflow:hidden;
	    white-space:nowrap;
	    text-overflow:ellipsis;
	}
	.table th{
		text-align: center;
	}
	.table{
		 table-layout: fixed;
		 text-align: center;
	}
	.det_info{
		display:none;
	}
	.order-table tr:nth-child(1){

		background: #337AB7;
		color: white;
		height: 45px;
		line-height: 45px;
	}
	.order-table td{
		width:250px;
		background: white;
	}
	.btn-default{
		margin-right:20px;
		width: 95px;
	}
	.cover{
		background:rgb(16,16,16,0.6);
		width: 100%;
		height: 100%;
		position: absolute;
		top:0px;
		left: 0px;
		display: none;
	}
	.pic{
		background:#fff;
		width: 500px;
		height:300px;
		text-align:center;
		margin:200px auto;
		border:1px solid black;
		border-radius: 15px;
		padding-top:50px; 
		font-size: 18px;
	}
	.pic>input{
		margin-left:10px;
		margin-bottom:40px;
		width: 200px;
		height:35px;
		font-size: 16px;
	}
</style>
<link
	href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"
	rel="stylesheet">
<link
	href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"
	rel="stylesheet">
<link href="./css/both.css" rel="stylesheet">
<link href="./css/sfq.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery.js"></script>
<script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
<script src="http://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>
	<div class="header">威派格智慧水务</div>
	<div class="container">
		<div class="area"></div>
		<!-- 添加手风琴样式内容 -->
		<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
		</div>
		<div class="det_info">
		</div>
	</div>
	<div class="foot">
		Copyright ©2019 <a href="#">威派格智慧水务</a>. All rights reserved.
	</div>
	<div class="cover">
		<div class="pic">
			姓名:<input class="picName" type="text"><br>
			电话:<input class="tel" type="text"><br>
			<input type="hidden">
			<button class='btn btn-default' type='button' onclick='updateInfo()'>提交</button>
			<button class='btn btn-default' type='button' onclick='cancelUpdate()'>取消</button>
		</div>
	</div>
</body>
<script>
	init();
	function init() {
		$.ajax({
			type : "GET",
			url : "user_showWater_Division.do",
			success : function(data) {
				console.log(data);
				if(data.length>0){
					$(".area").html("<h3>"+data[0].region+"</h3>");
				}
				$("#accordion").html("");
				//data为当前大区的所有水司数据
				for (var i = 0; i <data.length; i++) {
					var str="<div class='panel panel-default'><div class='panel-heading' role='tab' id='heading"+i+"'><h4 class='panel-title'>";
					var str1 = data[i].wId+",\""+data[i].pic.pName+"\",\""+data[i].pic.pTel+"\"";
					if(i==0){
						str+="<a role='button' data-toggle='collapse' data-parent='#accordion' href='#collapse"+i+"' aria-expanded='true' aria-controls='collapse"+i+"'>"+
						data[i].wName+"负责人："+data[i].pic.pName+"电话："+data[i].pic.pTel+"</a></h4></div><div id='collapse"+i+"' class='panel-collapse collapse in' role='tabpanel' aria-labelledby='heading"+i+"'><div class='panel-body'>"+
						"<table class='table table-bordered'><tr><th>订单编号</th><th>订单信息</th><th>订单总价 </th><th>订单数量</th><th></th></tr></table><button class='btn btn-default' type='button' onclick='createOrder("+data[i].wId+")'>生成订单</button>"+
						"<button class='btn btn-default' type='button' onclick='downloadOrder("+data[i].wId+")'>下载订单</button><button class='btn btn-default' type='button' onclick='updatePic("+str1+")'>"+
						"修改负责人</button></div></div></div>";
					}else{
						str+="<a  class='collapsed' role='button' data-toggle='collapse' data-parent='#accordion' href='#collapse"+i+"' aria-expanded='false' aria-controls='collapse"+i+"'>"+
						data[i].wName+"负责人："+data[i].pic.pName+"电话："+data[i].pic.pTel+"</a></h4></div><div id='collapse"+i+"' class='panel-collapse collapse' role='tabpanel' aria-labelledby='heading"+i+"'><div class='panel-body'>"+
						"<table class='table table-bordered'><tr><th>订单编号</th><th>订单信息</th><th>订单总价 </th><th>订单数量</th><th></th></tr></table><button class='btn btn-default' type='button' onclick='createOrder("+data[i].wId+")'>生成订单</button>"+
						"<button class='btn btn-default' type='button' onclick='downloadOrder("+data[i].wId+")'>下载订单</button><button class='btn btn-default' type='button' onclick='updatePic("+str1+")'>"+
						"修改负责人</button></div></div></div>";
					}
					$("#accordion").append(str);
					//该水司的订单对象
					var order=data[i].orderInfo;
					//遍历订单，往表格中添加具体数据
					for(var j=0;j<order.length;j++){
						//当前订单的物料信息
						var hardware=order[j].order_Hardwares;
						//记录所有物料名称及数量
						var hStr="";
						//记录物料的总价
						var sprice=0;
						for(var k=0;k<hardware.length;k++){
							var uprice=hardware[k].hardware_Group.hardwareList[0].price*hardware[k].multiple*hardware[k].hardware_Group.hardwareList[0].num;
							sprice+=uprice;
							var num=hardware[k].hardware_Group.hardwareList[0].num*hardware[k].multiple;
							hStr+=hardware[k].hardware_Group.hardwareList[0].name+"X"+num+" ";
						}
						$(".table").eq(i).append("<tr><td>"+j+"</td><td class='order_info'>"+hStr+"</td><td>"+sprice+"</td><td>"+
						"<input class='order_num' type='number' onchange='changeNum("+data[i].wId+","+order[j].oId+","+order[j].num+",this)' value='"+order[j].num+"'>"+
						"</td><td><a href='javascript:checkInfo("+order[j].oId+")'>查看详细信息</a>&nbsp;|&nbsp;<a href='javascript:delOrder("+order[j].oId+")'>删除</a></td></tr>");
					}
				}
			}
		});
	}
	function createOrder(wId){
		//传递参数并进行页面跳转
		var storage=window.localStorage;
		storage["wId"]=wId;
		location.href="user_forward.do?name=index";
	}
	function checkInfo(oId){
		$("#accordion").css("display","none");
		$(".det_info").css("display","block");
		//查询该订单的具体信息并写入表格中
		$.ajax({
				type:"GET",
				url : "user_showDetailOrder.do",
				data:{oId:oId},
				dataType : "json",
				success : function(data) {
					//console.log(data);
					$(".det_info").html("");
					$(".det_info").html("<table class='table table-bordered order-table'><tr><th>物料名称</th><th>数量</th><th>单位</th><th>品牌</th><th>规格型号 </th>"+
					"<th>价格</th></tr></table>");
					var str="";
					for(var i=0;i<data.length;i++){
						var hardware=data[i].hardware_Group.hardwareList[0];
						var num=hardware.num*data[i].multiple;
						$(".order-table").append("<tr><td>"+hardware.name+"</td><td>"+num+"</td><td>"+hardware.unit+"</td>"+
						"<td>"+hardware.brand+"</td><td>"+hardware.type+"</td><td>"+hardware.price+"</td></tr>");
					}
					$(".det_info").append("<button class='btn btn-default' type='button' onclick='updateShow("+oId+")'>修改订单 </button>"+
							"<button class='btn btn-default' type='button' onclick='cancel()'>返回 </button>");
				}
		})
	}
	function updateShow(oId){
		var storage=window.localStorage;
		storage["oId"]=oId;
		location.href="user_forward.do?name=update";
	}
	function cancel(){
		$("#accordion").css("display","block");
		$(".det_info").css("display","none");
	}
	function changeNum(wId,oId,num,obj){
		if(window.confirm("您确定要修改该订单数量吗?")){
			$.ajax({
				type:"GET",
				url:"user_updateOrderNum.do",
				data:{wId:wId,oId:oId,num:$(obj).val()},
				success:function(data){
					if(data==1){
						alert("修改成功");
						init();
					}else{
						alert("修改失败");
					}
				}
			})
		}else{
			$(obj).val(num);
		}
	}
	function delOrder(oId){
		$.ajax({
			type:"GET",
			url:"user_deleteOrder.do",
			data:{oId:oId},
			success:function(data){
				if(data==1){
					alert("删除成功");
					init();
				}else{
					alert("删除失败");
				}
			}
		})
	}
	function downloadOrder(wId){
		location.href="user_orderUploadAll.do?wId="+wId;
	}
	function updatePic(wId,name,tel){
		//修改负责人
		$(".cover").css("display","block");
		$(".picName").val(name);
		$(".tel").val(tel);
		$("[type='hidden']").val(wId);
	}
	function cancelUpdate(){
		$(".cover").css("display","none");
	}
	function updateInfo(){
		var name=$(".picName").val();
		var tel=$(".tel").val();
		var wId=$("[type='hidden']").val();
		$.ajax({
			type:"GET",
			url:"user_updatePic.do",
			data:{name:name,tel:tel,wId:wId},
			success:function(data){
				if(data==1){
					alert("修改成功");
					$(".cover").css("display","none");
					init();
				}else{
					alert("修改失败");
				}
			}
		})
	}
</script>
</html>